<script src="bundle.js"></script>
<script>
        
    var check_data = 
    {
        'family1':
        {
            person: { name: 'John' },
            pet: { name: 'kitty', species: 'cat' }
        },
        'family2':
        {
            person: { name: 'Simon' },
            pet: { name: 'waldo', species: 'dog' }
        },
        'family3':
        {
            person: { name: 'Walter' },
            pet: { name: 'goldie', species: 'fish' }
        },
        'sql_familyA':
        {
            person: { name: 'Sql-Johnny' },
            pet: { name: 'Sql-Doge', species: 'Dog' }
        },
        'sql_familyB':
        {
            person: { name: 'Sql-Emma' },
            pet: { name: 'Sql-Rabbit', species: 'Rabbit' }
        },
        'sql_familyC':
        {
            person: { name: 'C-Person' },
            pet: { name: 'C-Pet', species: 'Alien' }
        }
    };
    
	var sources =
	[
		'family1',
		'family2',
		'family3',
		'sql_familyA',
		'sql_familyB',
		'sql_familyC'
	];

	var app = require('loopback-app');
	
	var remoteDs = app.dataSources.remoteDS;
	var remotes = remoteDs.connector.remotes;
	
	var User = app.models.User;
	var Person = app.models.Person;
    
    var app_req_source = sources[0];
    remotes.before('**', function(ctx, next)
    {
        ctx.req.headers = 
        {
            datasource: app_req_source || 'nullsrc'
        };

        next();
    });
	
	var credentials = 
	{
		email: 'test@test.com',
		password: 'test'
	};
        
    var delay = 1;
    var start = new Date().getTime();
	var test_runner;
	User.login(credentials, function (err, token)
	{
		credentials.token = token;
		
		remotes.auth = 
		{
			bearer: btoa(token ? token.id : 'null'),
			sendImmediately: true
		};
		
        document.body.innerHTML += 'Logged in: ' + JSON.stringify(remotes.auth.bearer) + '<br>';
        document.body.innerHTML += 'Running tests, please wait... (~15-30 sec)';

        setTimeout(query, delay);
    });
	
    var run_idx = 0;
    var run_limit = 1000;
    var test_run = 1;
    
    var person_name_test = { ok: 0, failed: 0, rejected: 0 };
    var pet_name_test = { ok: 0, failed: 0, rejected: 0 };
    var pet_species_test = { ok: 0, failed: 0, rejected: 0 };
        
    var verbose = false;
    
	var query = function()
	{
        var curr_src = app_req_source;                
        var curr_run = test_run++;
        
		Person.find({ include: 'pets' }, function(err, items) {
            
            if (err)
            {
                if (verbose) document.body.innerHTML += "<b>Query-Error</b>: " + err + '<br>';
                
                run_idx = ++run_idx % sources.length;
                app_req_source = sources[run_idx];
                
                window.scrollTo(0,document.body.scrollHeight);
                setTimeout(query, delay);
                
                person_name_test.rejected++;
                pet_name_test.rejected++;
                pet_species_test.rejected++;
                
                return;
            }
            
          var chk = check_data[curr_src];
          
          var exec_check = function(family, check_name, check_value, ref_value, test_obj)
          {
              if (check_value !== ref_value)
              {
                  if (verbose) document.body.innerHTML += ("[" + curr_run + "] " + family + " &gt; " + check_name + " MISMATCH: " + check_value + " !== " + ref_value) + "<br>";
                  test_obj.failed++;
              }
              else
              {
                  if (verbose) document.body.innerHTML += ("[" + curr_run + "] " + family + " &gt; " + check_name + " MATCH: " + check_value + " === " + ref_value) + '<br>';
                  test_obj.ok++;
              }
          };
          
          if (!verbose)
          {
            var curr_time = new Date().getTime() - start;              
            document.body.innerHTML = '[' + test_run + '/' + run_limit + ', ' + (curr_time*0.001) + ' sec]<br/>';
          }
          
          if (chk && items && items.length > 0)
          {
              exec_check(curr_src, 'person-name', chk.person.name, items[0].name, person_name_test);
              exec_check(curr_src, 'pet-name', chk.pet.name, items[0].pets()[0].name, pet_name_test);
              exec_check(curr_src, 'pet-species', chk.pet.species, items[0].pets()[0].species, pet_species_test);
          }
                        
            if (curr_run >= run_limit)
            {
                var end = new Date().getTime();
                var time = end - start;

                var print_detail_test_result = function(test_name, test_obj)
                {
                    document.body.innerHTML += '<u>' + test_name + ' Results:</u><br>';
                    document.body.innerHTML += '<span style="color: green">OK: ' + test_obj.ok + '</span><br>';
                    document.body.innerHTML += '<span style="color: red">FAILED: ' + test_obj.failed + '</span><br>';
                    document.body.innerHTML += '<span style="color: orange">REJECTED: ' + test_obj.rejected + '</span><br>';
                }

                clearInterval(test_runner);
                document.body.innerHTML += 'Finished Tests: <br>';
                
                print_detail_test_result('Person-Name Test', person_name_test);
                print_detail_test_result('Pet-Name Test', pet_name_test);
                print_detail_test_result('Pet-Species Test', pet_species_test);

                document.body.innerHTML += 'Total Time elapsed: ' + (time*0.001) + ' sec<br>';
                window.scrollTo(0,document.body.scrollHeight);
                return;
            }
            
            run_idx = ++run_idx % sources.length;
            app_req_source = sources[run_idx];
            
            window.scrollTo(0,document.body.scrollHeight);
            setTimeout(query, delay);
		});
	}	
</script>
